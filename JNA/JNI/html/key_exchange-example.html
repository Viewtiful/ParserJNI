<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>JNI parser: key_exchange</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">JNI parser
   
   </div>
   <div id="projectbrief">Generating Java/JNI code in order to call native C functions.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">key_exchange</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><span class="keyword">import</span> java.io.IOException;
<span class="keyword">import</span> java.io.FileNotFoundException;
<span class="keyword">import</span> java.io.FileOutputStream;
<span class="keyword">import</span> java.io.OutputStream;

<span class="keyword">public</span> <span class="keyword">class </span>kep
{
        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> main(String[] args) <span class="keywordflow">throws</span> Exception{
                ArcanaJNI aJNI = <span class="keyword">new</span> ArcanaJNI();

                <span class="keywordflow">if</span>( aJNI.ktb_init() == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;KTB INIT DONE&quot;</span>);
                }

                System.out.println(<span class="stringliteral">&quot;nb curve : &quot;</span> + aJNI.ktb_curves_count());

                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; aJNI.ktb_curves_count(); ++i) {
                        System.out.println(aJNI.ktb_curves_id(i));
                }


                ArcanaJNI.ktb_kep_sts_t algo_params = aJNI.new ktb_kep_sts_t();
                ArcanaJNI.AddressWrapper ctx = <span class="keyword">new</span> ArcanaJNI.AddressWrapper();
                ArcanaJNI.AddressWrapper public_key = <span class="keyword">new</span> ArcanaJNI.AddressWrapper();
                ArcanaJNI.AddressWrapper private_key = <span class="keyword">new</span> ArcanaJNI.AddressWrapper();  
                <span class="keywordtype">long</span> shared_key_size = 64;

                <span class="keywordflow">if</span>( aJNI.ktb_keys_generate_keypair(0, <span class="stringliteral">&quot;nistP521&quot;</span>, public_key, private_key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_keys_generate_keypair ok&quot;</span>);   
                }

                algo_params.cipher_algo = ArcanaJNI.ktb_cipher_algo_t.KTB_CIPHER_ALGO_AES256;
                algo_params.peer_public_key = public_key.getAddress();
                algo_params.self_private_key = private_key.getAddress();
                algo_params.write();
                algo_params.read();

                <span class="keywordtype">long</span> public_buffer_size = aJNI.ktb_keys_public_key_export_size(public_key.getAddress());
                System.out.println(<span class="stringliteral">&quot;Taille public_buffer_size : &quot;</span> + public_buffer_size);
                byte[] public_buffer = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>)public_buffer_size];
                <span class="keywordflow">if</span>( aJNI.ktb_keys_public_key_export(public_key.getAddress(), public_buffer) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_keys_public_key_export ok&quot;</span>); 

                        StringBuilder sb = <span class="keyword">new</span> StringBuilder();
                        <span class="keywordflow">for</span>(byte b : public_buffer) 
                                sb.append(String.format(<span class="stringliteral">&quot;%02X &quot;</span>, b));
                        System.out.println(sb.toString()); 

         OutputStream oos = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;public_key.txt&quot;</span>); 
         oos.write(public_buffer);
         oos.close();
                } 
                System.out.println(<span class="stringliteral">&quot;&quot;</span>);

                <span class="keywordtype">long</span> private_buffer_size = aJNI.ktb_keys_private_key_export_size(private_key.getAddress());
                System.out.println(<span class="stringliteral">&quot;Taille private_buffer_size : &quot;</span> + private_buffer_size);
                byte[] private_buffer = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>)private_buffer_size];
                <span class="keywordflow">if</span>( aJNI.ktb_keys_private_key_export(private_key.getAddress(), private_buffer) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_keys_private_key_export ok&quot;</span>); 

                        StringBuilder sb = <span class="keyword">new</span> StringBuilder();
                        <span class="keywordflow">for</span>(byte b : private_buffer) 
                                sb.append(String.format(<span class="stringliteral">&quot;%02X &quot;</span>, b));
                        System.out.println(sb.toString());  

         OutputStream oos = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;private_key.txt&quot;</span>); 
         oos.write(private_buffer);
         oos.close();
                }    

                <span class="keywordflow">if</span>(aJNI.ktb_kep_init(ctx, 0, ArcanaJNI.ktb_kep_algo_t.KTB_KEP_ALGO_STS, algo_params.getMInternal().getAddress(), algo_params.struct_size, <span class="stringliteral">&quot;nistP521&quot;</span>, ArcanaJNI.ktb_hash_algo_t.KTB_HASH_ALGO_SHA512, shared_key_size, 2) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_kep_init ok&quot;</span>);   
                }
                <span class="keywordflow">else</span> {
                        byte[] resultat = <span class="keyword">new</span> byte[256];
                        <span class="keywordtype">int</span> retour = aJNI.ktb_strerror(ArcanaJNI.ktb_errno.KTB_ERR_INVALID_PARAMS, resultat);

                        StringBuilder sb = <span class="keyword">new</span> StringBuilder();
                        <span class="keywordflow">for</span>(byte b : resultat) 
                                sb.append(String.format(<span class="stringliteral">&quot;%02X &quot;</span>, b));
                        System.out.println(sb.toString());
                        System.out.println(<span class="stringliteral">&quot;probleme&quot;</span>);   
                }

                ArcanaJNI.BoolWrapper cont = <span class="keyword">new</span> ArcanaJNI.BoolWrapper();
                <span class="keywordtype">int</span> iter_max_left = 10;

                <span class="keywordflow">do</span> {
                        byte[] data = aJNI.ktb_kep_get_data(ctx.getAddress());
                        <span class="keywordflow">if</span>(aJNI.ktb_kep_put_data(ctx.getAddress(), data, cont) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                                System.out.println(<span class="stringliteral">&quot;ktb_kep_put_data ok&quot;</span>);
                        }
                } <span class="keywordflow">while</span> (cont.getValue() &amp;&amp; (--iter_max_left &gt;= 0));

                byte[] secret_key = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>)shared_key_size];
                <span class="keywordflow">if</span>(aJNI.ktb_kep_finalise(ctx.getAddress(), secret_key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_kep_finalise ok&quot;</span>);
                }

                System.out.println(<span class="stringliteral">&quot;Generated key : &quot;</span>);
                StringBuilder sb = <span class="keyword">new</span> StringBuilder();
                <span class="keywordflow">for</span>(byte b : secret_key) 
                        sb.append(String.format(<span class="stringliteral">&quot;%02X &quot;</span>, b));
                System.out.println(sb.toString());

        aJNI.ktb_keys_public_key_clear(public_key.getAddress());
        aJNI.ktb_keys_private_key_clear(private_key.getAddress());
        aJNI.ktb_kep_clear(ctx.getAddress());

        aJNI.ktb_clear();
}
}
</pre></div><hr/>
 <h1>Output example</h1>
<div class="fragment"><pre class="fragment">18:03:36 : ktb_init() ok
nb curve : 8
nistP192
nistP224
nistP256
nistP384
nistP521
arcanaP256
arcanaP384
arcanaP512
ktb_keys_generate_keypair ok
Taille public_buffer_size : 153
ktb_keys_public_key_export ok
45 43 50 55 08 6E 69 73 74 50 35 32 31 00 00 00 00 00 05 42 01 48 7D AE AF 9F 4F 89 39 07 6E 59 7F 02 AA 52 44 D0 AD 43 89 B7 7E 47 A1 DB 25 72 0E 75 4A 16 F6 00 B1 8B 87 14 22 8D 1D 15 D6 D0 68 4A 95 63 F4 39 5C AD AE 6C 19 5F 06 9D 0A 97 30 8E 72 88 D1 01 42 01 7A 48 36 77 8F AF F5 4D AC A7 91 58 10 87 3C 48 7A 5E 3E A5 84 AA 03 FD 5E E6 BD D2 BC 1A 90 C8 95 AE 8B 06 BE BE 11 D7 AD 76 65 43 FD E4 15 9E 16 58 A3 8E 82 20 5D B6 2B 49 CC 47 6C 29 E4 08 08 

Taille private_buffer_size : 83
ktb_keys_private_key_export ok
45 43 50 52 08 6E 69 73 74 50 35 32 31 00 00 00 00 41 BA 0F E2 49 27 72 41 BF 80 27 12 28 A9 7E 2A FF C7 0D 59 DB 27 63 2B 5A DE A6 77 FB 62 76 10 68 E4 C4 30 AF 56 60 5A F7 2D FE C2 46 80 88 AB 97 1E 5A C6 C0 D7 89 7A 7F F4 7C 17 BC C9 F0 AD 9B E6 
ktb_kep_init ok
ktb_kep_put_data ok
ktb_kep_put_data ok
ktb_kep_put_data ok
ktb_kep_put_data ok
ktb_kep_finalise ok
Generated key : 
66 81 9B A6 30 B6 F7 78 12 E8 4F 33 B3 D0 C9 7E 82 FC B4 6D FB CB 5F 15 84 5F 2F 70 A8 7A 2B 1D 5B A0 33 A2 6A 62 30 18 36 B5 65 DD E6 65 CD 83 DC DC 75 4B DB 27 A0 52 AD 86 E9 7D 0A 16 2D DA 
</pre></div><div class="fragment"><pre class="fragment"></pre></div> </div><!-- contents -->
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<i>JNI Parser - Laboratoire ERISCS</i>
