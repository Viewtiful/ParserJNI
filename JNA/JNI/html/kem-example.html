<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>JNI parser: kem</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">JNI parser
   
   </div>
   <div id="projectbrief">Generating Java/JNI code in order to call native C functions.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">kem</div>  </div>
</div><!--header-->
<div class="contents">
<h1>Goal</h1>
<p>This sample illustrates how the Key Encapsulation Mechanism works. It generates a random secret key and cipher it using a public key. The ciphered secret key can then only be deciphered using the associated private key.</p>
<hr/>
 <h1>Usage</h1>
<p>In order to run the example, you need to have : </p>
<ul>
<li>
libArcanaJNI.so </li>
<li>
ArcanaJNI.java </li>
<li>
The Utils.java class </li>
<li>
A public key in a file named "public_key.txt" </li>
<li>
A private key in a file named "private_key.txt" </li>
<li>
And of course kem.java </li>
</ul>
<p>The function generateKey() generate and cipher a secret key based on the public key from the file public_key.txt The result of this function is the creation of two files; one with the secret key in clear, and one with the encaspulated key, ciphered. This file can then be sent to the owner of the private key corresponding to the public key we used.</p>
<p>To retrieve the secret key with the encapsulated file, the function retrieveKey() does the job. It uses the private key and this will result in the creation of the secret key file, containing the same key generated previously.</p>
<div class="fragment"><pre class="fragment"><span class="keyword">import</span> java.io.File;
<span class="keyword">import</span> java.io.FileInputStream;
<span class="keyword">import</span> java.io.FileOutputStream;
<span class="keyword">import</span> java.io.InputStream;
<span class="keyword">import</span> java.io.OutputStream;

<span class="keyword">public</span> <span class="keyword">class </span>kem {

        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> main(String[] args) <span class="keywordflow">throws</span> Exception {
                ArcanaJNI aJNI = <span class="keyword">new</span> ArcanaJNI();

                <span class="keywordflow">if</span> (aJNI.ktb_init() == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR)
                        System.out.println(Utils.getCurrentTime() + <span class="stringliteral">&quot;ktb_init() ok&quot;</span>);
                <span class="keywordflow">else</span> {
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;Error while initializating ktb_init()&quot;</span>);
                        System.exit(1);
                }

                <span class="keywordflow">if</span> (!kem.generateKey(aJNI)) {
                        aJNI.ktb_clear();
                        System.exit(1);
                }

                <span class="keywordflow">if</span> (!kem.retrieveKey(aJNI)) {
                        aJNI.ktb_clear();
                        System.exit(1);
                }

                aJNI.ktb_clear();
        }

        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span> generateKey(ArcanaJNI aJNI) <span class="keywordflow">throws</span> Exception {
                ArcanaJNI.AddressWrapper public_key = <span class="keyword">new</span> ArcanaJNI.AddressWrapper();

                File file = <span class="keyword">new</span> File(<span class="stringliteral">&quot;public_key.txt&quot;</span>);
                InputStream ios = <span class="keyword">new</span> FileInputStream(file);
                <span class="keywordtype">int</span> key_buffer_size = (int) file.length();
                byte[] key_buffer = <span class="keyword">new</span> byte[key_buffer_size];

                System.out.println(<span class="stringliteral">&quot;key_buffer_size : &quot;</span> + key_buffer_size);

                ios.read(key_buffer);

                <span class="keywordflow">if</span> (aJNI.ktb_keys_public_key_import(key_buffer, public_key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR)
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;ktb_keys_public_key_import() ok&quot;</span>);
                <span class="keywordflow">else</span> {
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;Error at ktb_keys_public_key_import()&quot;</span>);
                        Utils.freeBuffer(key_buffer);
                        public_key = null;
                        ios.close();
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }

                byte[] secret_key = <span class="keyword">new</span> byte[128];

                <span class="keywordtype">long</span> encapsulated_size = aJNI.ktb_kem_psec_encrypt_size(public_key
                                .getAddress());
                System.out.println(<span class="stringliteral">&quot;encapsulated_size : &quot;</span> + encapsulated_size);

                byte[] encapsulated = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) encapsulated_size];

                <span class="keywordflow">if</span> (aJNI.ktb_kem_psec_encrypt(
                                ArcanaJNI.ktb_hash_algo_t.KTB_HASH_ALGO_SKEIN512, 0,
                                public_key.getAddress(), secret_key, encapsulated) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR)
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;ktb_kem_psec_encrypt() ok&quot;</span>);
                <span class="keywordflow">else</span> {
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;Error at ktb_kem_psec_encrypt()&quot;</span>);
                        Utils.freeBuffer(key_buffer);
                        Utils.freeBuffer(encapsulated);
                        Utils.freeBuffer(secret_key);
                        public_key = null;
                        ios.close();
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }

                OutputStream oos = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;secret_key.txt&quot;</span>);
                OutputStream oos2 = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;encapsulated.txt&quot;</span>);

                oos.write(secret_key);
                oos2.write(encapsulated);

                oos.close();
                oos2.close();
                Utils.freeBuffer(key_buffer);
                Utils.freeBuffer(encapsulated);
                Utils.freeBuffer(secret_key);
                aJNI.ktb_keys_public_key_clear(public_key.getAddress());
                public_key = null;
                ios.close();

                <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }

        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">boolean</span> retrieveKey(ArcanaJNI aJNI) <span class="keywordflow">throws</span> Exception {
                ArcanaJNI.AddressWrapper private_key = <span class="keyword">new</span> ArcanaJNI.AddressWrapper();

                File file = <span class="keyword">new</span> File(<span class="stringliteral">&quot;private_key.txt&quot;</span>);
                InputStream ios = <span class="keyword">new</span> FileInputStream(file);
                <span class="keywordtype">int</span> key_buffer_size = (int) file.length();
                byte[] key_buffer = <span class="keyword">new</span> byte[key_buffer_size];

                System.out.println(<span class="stringliteral">&quot;key_buffer_size : &quot;</span> + key_buffer_size);

                ios.read(key_buffer);

                <span class="keywordflow">if</span> (aJNI.ktb_keys_private_key_import(key_buffer, private_key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR)
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;ktb_keys_private_key_import() ok&quot;</span>);
                <span class="keywordflow">else</span> {
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;Error at ktb_keys_private_key_import()&quot;</span>);
                        Utils.freeBuffer(key_buffer);
                        private_key = null;
                        ios.close();
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }

                byte[] secret_key = <span class="keyword">new</span> byte[128];

                File file2 = <span class="keyword">new</span> File(<span class="stringliteral">&quot;encapsulated.txt&quot;</span>);
                InputStream ios2 = <span class="keyword">new</span> FileInputStream(file2);
                <span class="keywordtype">long</span> encapsulated_size = (int) file2.length();
                byte[] encapsulated = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) encapsulated_size];

                System.out.println(<span class="stringliteral">&quot;encapsulated_size : &quot;</span> + encapsulated_size);

                ios2.read(encapsulated);

                <span class="keywordflow">if</span> (aJNI.ktb_kem_psec_decrypt(
                                ArcanaJNI.ktb_hash_algo_t.KTB_HASH_ALGO_SKEIN512,
                                private_key.getAddress(), encapsulated, secret_key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR)
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;ktb_kem_psec_decrypt() ok&quot;</span>);
                <span class="keywordflow">else</span> {
                        System.out.println(Utils.getCurrentTime()
                                        + <span class="stringliteral">&quot;Error at ktb_kem_psec_decrypt()&quot;</span>);
                        Utils.freeBuffer(key_buffer);
                        Utils.freeBuffer(encapsulated);
                        Utils.freeBuffer(secret_key);
                        private_key = null;
                        ios.close();
                        <span class="keywordflow">return</span> <span class="keyword">false</span>;
                }

                OutputStream oos = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;secret_key2.txt&quot;</span>);

                oos.write(secret_key);

                oos.close();
                
                Utils.freeBuffer(key_buffer);
                Utils.freeBuffer(encapsulated);
                Utils.freeBuffer(secret_key);
                aJNI.ktb_keys_private_key_clear(private_key.getAddress());
                private_key = null;
                ios.close();

                <span class="keywordflow">return</span> <span class="keyword">true</span>;
        }
}
</pre></div><hr/>
 <h1>Output example</h1>
<div class="fragment"><pre class="fragment">17:37:50 : ktb_init() ok
key_buffer_size : 153
17:37:50 : ktb_keys_public_key_import() ok
encapsulated_size : 203
17:37:50 : ktb_kem_psec_encrypt() ok
key_buffer_size : 83
17:37:50 : ktb_keys_private_key_import() ok
encapsulated_size : 203
17:37:51 : ktb_kem_psec_decrypt() ok
</pre></div><div class="fragment"><pre class="fragment"></pre></div> </div><!-- contents -->
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<i>JNI Parser - Laboratoire ERISCS</i>
