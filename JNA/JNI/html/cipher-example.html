<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>JNI parser: cipher</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">JNI parser
   
   </div>
   <div id="projectbrief">Generating Java/JNI code in order to call native C functions.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">cipher</div>  </div>
</div><!--header-->
<div class="contents">
<h1>Goal</h1>
<p>The cipher sample show how to cipher and decipher a file. It works with the "basic" counter mode.</p>
<p>It's also a basic example on how to generate a secret key with a suitable length for ciphering.</p>
<hr/>
 <h1>Usage</h1>
<p>This sample can work in two mode : ciphering and deciphering, each mode available in counter mode.</p>
<p>In order to run the example, you need to have : </p>
<ul>
<li>
libArcanaJNI.so </li>
<li>
ArcanaJNI.java </li>
<li>
A file named data.txt containing what you want to cipher </li>
<li>
And of course cipher.java </li>
</ul>
<h1>Ciphering a file</h1>
<p>This call will cipher the data.txt file and put the ciphered content in data_cipher.txt.</p>
<p>The (auth. data) is a string used to validate the origin of the data. The recipient of the ciphered data must know it to check the integrity of the file, although it doesn't need to be "critical" in term of security (it can even be transmitted in clear alongside the ciphered data).</p>
<h1>Deciphering a file</h1>
<p>This time, the program will decipher the content of data_cipher.txt file into decipher.txt.</p>
<div class="fragment"><pre class="fragment">
<span class="keyword">import</span> java.io.IOException;
<span class="keyword">import</span> java.io.FileInputStream;
<span class="keyword">import</span> java.io.InputStream;
<span class="keyword">import</span> java.io.FileOutputStream;
<span class="keyword">import</span> java.io.OutputStream;

<span class="keyword">public</span> <span class="keyword">class </span>cipher {
        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">void</span> main(String[] args) {
                ArcanaJNI aJNI = <span class="keyword">new</span> ArcanaJNI();
                cipher c = <span class="keyword">new</span> cipher();

                byte[] password = <span class="keyword">new</span> byte[] { (byte) 1, (byte) 14, (byte) 3 };
                ArcanaJNI.AddressWrapper ctx = <span class="keyword">new</span> ArcanaJNI.AddressWrapper();

                <span class="keywordflow">if</span> (aJNI.ktb_init() == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb init ok&quot;</span>);
                }

                <span class="keywordflow">if</span> (aJNI.ktb_cipher_init(ctx,
                                        ArcanaJNI.ktb_cipher_algo_t.KTB_CIPHER_ALGO_AES256,
                                        ArcanaJNI.ktb_cipher_mode_t.KTB_CIPHER_MODE_CBC, <span class="keyword">true</span>) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {

                        System.out.println(<span class="stringliteral">&quot;ktb_cipher_init ok&quot;</span>);
                }

                <span class="keywordtype">long</span> key_size = aJNI.ktb_cipher_get_key_len(ctx.getAddress());
                System.out.println(<span class="stringliteral">&quot;key size : &quot;</span> + key_size);

                byte[] key = c.generate_key(aJNI, password, key_size);

                StringBuilder sb = <span class="keyword">new</span> StringBuilder();
                <span class="keywordflow">for</span> (byte b : key)
                        sb.append(String.format(<span class="stringliteral">&quot;%02X &quot;</span>, b));
                System.out.println(sb.toString());

                <span class="keywordflow">if</span> (aJNI.ktb_cipher_set_key(ctx.getAddress(), key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_cipher_set_key ok&quot;</span>);
                }

                <span class="keywordtype">long</span> iv_size = aJNI.ktb_cipher_get_iv_len(ctx.getAddress());

                System.out.println(<span class="stringliteral">&quot;iv_size : &quot;</span> + iv_size);

                byte[] iv = c.random(aJNI, iv_size);

                <span class="keywordflow">if</span> (aJNI.ktb_cipher_set_iv(ctx.getAddress(), iv) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_cipher_set_iv ok&quot;</span>);
                }

                <span class="keywordflow">try</span> {
                        InputStream ios = <span class="keyword">new</span> FileInputStream(<span class="stringliteral">&quot;data.txt&quot;</span>);
                        OutputStream oos = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;data_cipher.txt&quot;</span>);

                        oos.write(iv);
                        <span class="comment">// Useless, just trying if it&#39;s working</span>
                        System.out.println(<span class="stringliteral">&quot;ktb_cipher_get_prefix_size : &quot;</span>
                                        + aJNI.ktb_cipher_get_prefix_size(ctx.getAddress()));

                        <span class="keywordtype">boolean</span> pad_output_size = <span class="keyword">true</span>;
                        <span class="keywordtype">long</span> block_size = aJNI.ktb_cipher_get_block_len(ctx.getAddress());
                        System.out.println(<span class="stringliteral">&quot;block_size : &quot;</span> + block_size);
                        <span class="keywordtype">long</span> buffer_size = (4096 / block_size) * block_size;
                        byte[] data = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) buffer_size];
                        <span class="keywordtype">int</span> read = 0;

                        <span class="keywordflow">do</span> {

                                read = ios.read(data);
                                <span class="keywordflow">if</span> (read &gt; 0) {
                                        <span class="keywordtype">long</span> blockrounded_read_count;

                                        <span class="keywordflow">if</span> (pad_output_size) {
                                                blockrounded_read_count = (read / block_size)
                                                        * block_size;

                                                <span class="keywordflow">if</span> (read % block_size != 0) {
                                                        blockrounded_read_count += block_size;
                                                }
                                        } <span class="keywordflow">else</span> {
                                                blockrounded_read_count = read;
                                        }

                                        byte[] buffer_in = <span class="keyword">new</span> byte[read];
                                        System.arraycopy(data, 0, buffer_in, 0, buffer_in.length);

                                        byte[] buffer_out = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) blockrounded_read_count];
                                        System.arraycopy(data, 0, buffer_out, 0, buffer_out.length);

                                        <span class="keywordflow">if</span> (aJNI.ktb_cipher_encrypt_block(ctx.getAddress(),
                                                                buffer_in, buffer_out) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                                                System.out.println(<span class="stringliteral">&quot;ktb_cipher_encrypt_block ok&quot;</span>);
                                        }

                                        oos.write(buffer_out);
                                }
                        } <span class="keywordflow">while</span> (read == buffer_size);

                        aJNI.ktb_cipher_finalise(ctx.getAddress());

                        <span class="keywordtype">long</span> suffix_size = aJNI
                                .ktb_cipher_get_suffix_size(ctx.getAddress());
                        System.out.println(<span class="stringliteral">&quot;suffix_size : &quot;</span> + suffix_size);

                        <span class="keywordflow">if</span> (suffix_size &gt; 0) {
                                byte[] suffix = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) suffix_size];

                                aJNI.ktb_cipher_get_suffix(ctx.getAddress(), suffix);
                                oos.write(suffix);
                        }

                        aJNI.ktb_cipher_clear(ctx.getAddress());

                        <span class="keywordflow">if</span> (aJNI.ktb_cipher_init(ctx,
                                                ArcanaJNI.ktb_cipher_algo_t.KTB_CIPHER_ALGO_AES256,
                                                ArcanaJNI.ktb_cipher_mode_t.KTB_CIPHER_MODE_CBC, <span class="keyword">false</span>) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {

                                System.out.println(<span class="stringliteral">&quot;ktb_cipher_init ok&quot;</span>);
                        }
                        key_size = aJNI.ktb_cipher_get_key_len(ctx.getAddress());
                        System.out.println(<span class="stringliteral">&quot;key size : &quot;</span> + key_size);

                        key = c.generate_key(aJNI, password, key_size);

                        <span class="keywordflow">if</span> (aJNI.ktb_cipher_set_key(ctx.getAddress(), key) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                                System.out.println(<span class="stringliteral">&quot;ktb_cipher_set_key ok&quot;</span>);
                        }

                        ios.close();
                        oos.close();

                        OutputStream oos2 = <span class="keyword">new</span> FileOutputStream(<span class="stringliteral">&quot;decipher.txt&quot;</span>);
                        InputStream ios2 = <span class="keyword">new</span> FileInputStream(<span class="stringliteral">&quot;data_cipher.txt&quot;</span>);

                        iv_size = aJNI.ktb_cipher_get_iv_len(ctx.getAddress());
                        System.out.println(<span class="stringliteral">&quot;iv_size : &quot;</span> + iv_size);
                        iv = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) iv_size];

                        ios2.read(iv);

                        <span class="keywordflow">if</span> (aJNI.ktb_cipher_set_iv(ctx.getAddress(), iv) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                                System.out.println(<span class="stringliteral">&quot;ktb_cipher_set_iv ok&quot;</span>);
                        }

                        buffer_size = (4096 / block_size) * block_size;
                        byte[] data2 = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) buffer_size];
                        System.out.println(<span class="stringliteral">&quot;buffer_size : &quot;</span> + buffer_size);
                        <span class="keywordtype">long</span> prefix_size = aJNI
                                .ktb_cipher_get_prefix_size(ctx.getAddress());
                        System.out.println(<span class="stringliteral">&quot;prefix_size : &quot;</span> + prefix_size);
                        <span class="keywordflow">do</span> {
                                read = ios2.read(data2);

                                <span class="keywordflow">if</span> (read &gt; 0) {
                                        byte[] buffer_out = <span class="keyword">new</span> byte[read];
                                        System.arraycopy(data2, 0, buffer_out, 0, buffer_out.length);

                                        <span class="keywordflow">if</span> (aJNI.ktb_cipher_decrypt_block(ctx.getAddress(),
                                                                buffer_out, buffer_out) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                                                System.out.println(<span class="stringliteral">&quot;ktb_cipher_decrypt_block ok&quot;</span>);
                                        } <span class="keywordflow">else</span> {
                                                System.out.println(<span class="stringliteral">&quot;ktb_cipher_decrypt_block probleme&quot;</span>);
                                        }

                                        oos2.write(buffer_out);
                                }
                        } <span class="keywordflow">while</span> (read == buffer_size);

                        aJNI.ktb_cipher_finalise(ctx.getAddress());

                        <span class="keywordtype">long</span> output_size = aJNI.ktb_cipher_get_data_size(ctx.getAddress());
                        System.out.println(<span class="stringliteral">&quot;output_size : &quot;</span> + output_size);

                        aJNI.ktb_cipher_clear(ctx.getAddress());
                        oos2.close();
                        ios2.close();
                } <span class="keywordflow">catch</span> (IOException e) {
                }

                aJNI.ktb_clear();
        }

        byte[] random(ArcanaJNI aJNI, <span class="keywordtype">long</span> iv_size) {
                byte[] result = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) iv_size];

                <span class="keywordflow">if</span> (aJNI.ktb_prng_fill_buffer(0, result) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_prn_fill_buffer ok&quot;</span>);
                }

                <span class="keywordflow">return</span> result;
        }

        byte[] generate_key(ArcanaJNI aJNI, byte[] password, <span class="keywordtype">long</span> key_size) {
                byte[] result = <span class="keyword">new</span> byte[(int) (<span class="keywordtype">long</span>) key_size];

                <span class="keywordflow">if</span> (aJNI.ktb_kdf(ArcanaJNI.ktb_hash_algo_t.KTB_HASH_ALGO_SKEIN512,
                                        password, result) == ArcanaJNI.ktb_errno.KTB_ERR_NO_ERROR) {
                        System.out.println(<span class="stringliteral">&quot;ktb_kdf ok&quot;</span>);
                }

                <span class="keywordflow">return</span> result;
        }

}
</pre></div><hr/>
 <h1>Output example</h1>
<div class="fragment"><pre class="fragment">ktb init ok
ktb_cipher_init ok
key size : 32
ktb_kdf ok
F1 FC 02 FB 12 1C 50 36 86 BD A4 73 D0 AD 15 5F E5 45 D8 6D 2F B2 70 6A 8E 6C 9E 3F 09 87 A4 42 
ktb_cipher_set_key ok
iv_size : 16
ktb_prn_fill_buffer ok
ktb_cipher_set_iv ok
ktb_cipher_get_prefix_size : 0
block_size : 16
ktb_cipher_encrypt_block ok
suffix_size : 0
ktb_cipher_init ok
key size : 32
ktb_kdf ok
ktb_cipher_set_key ok
iv_size : 16
ktb_cipher_set_iv ok
buffer_size : 4096
prefix_size : 0
ktb_cipher_decrypt_block ok
output_size : 565
</pre></div><div class="fragment"><pre class="fragment"></pre></div> </div><!-- contents -->
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<i>JNI Parser - Laboratoire ERISCS</i>
